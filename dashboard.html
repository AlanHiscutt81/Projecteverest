<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Everest - Shift Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8 font-sans text-slate-900">
    <div class="max-w-[1500px] mx-auto">
        <nav class="flex gap-4 mb-6">
            <a href="#" class="bg-blue-900 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase shadow-lg">Dashboard</a>
            <a href="Staff.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Staff</a>
            <a href="invoices.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Invoicing</a>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="bg-white p-8 rounded-[40px] shadow-xl border-t-8 border-orange-500 h-fit">
                <h3 class="font-black uppercase text-[10px] mb-6 text-orange-600 italic tracking-widest text-center">1. Request Vacancy</h3>
                <div class="space-y-4">
                    <select id="homeSelect" class="w-full p-4 border-2 rounded-2xl font-black bg-slate-50"><option value="Everest Home">Everest Home</option></select>
                    <input id="shiftDate" type="date" class="w-full p-4 border-2 rounded-2xl font-bold bg-slate-50">
                    <select id="roleReq" class="w-full p-4 border-2 rounded-2xl font-black bg-slate-50"><option>RGN</option><option>HCA</option></select>
                    <button onclick="createShift()" class="w-full bg-orange-600 text-white py-5 rounded-3xl font-black uppercase shadow-xl hover:bg-black">Add to Rota</button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-4 rounded-[30px] shadow-sm mb-6 border border-slate-200">
                    <h2 class="text-sm font-black uppercase text-slate-400 ml-4 italic">Active Rota</h2>
                </div>
                <div id="rotaDisplay" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const STAFF_KEY = 'everest_v5_final';
        const SHIFT_KEY = 'ev_shifts_master';

        async function fetchGoogleData() {
            console.log("Attempting to fetch from Google...");
            // We use the CSV export link because it is more reliable for your specific "Cell B2" layout
            const url = "https://docs.google.com/spreadsheets/d/1WvEFHXZrjS3czyjedOLKCcxz6Agt26pTPR33B23kQLo/export?format=csv";
            
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                
                // This logic finds the JSON blob inside your CSV export
                const lines = csvText.split('\n');
                if (lines.length > 1) {
                    let jsonRaw = lines[1].split(',')[1]; // Gets Column B
                    // Clean up extra quotes Google adds to CSVs
                    if (jsonRaw.startsWith('"')) jsonRaw = jsonRaw.substring(1, jsonRaw.length - 1).replace(/""/g, '"');
                    
                    const staff = JSON.parse(jsonRaw);
                    localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
                    console.log("SUCCESS! Staff Loaded:", staff);
                    renderRota();
                }
            } catch (e) {
                console.error("Critical Load Error:", e);
                alert("Database connection failed. Ensure your Google Sheet is 'Published to Web'.");
            }
        }

        function createShift() {
            const date = document.getElementById('shiftDate').value;
            const role = document.getElementById('roleReq').value;
            if(!date) return alert("Select a date");
            
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            shifts.push({ id: Date.now(), date, role, home: "Everest Home", staffId: null });
            localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
            renderRota();
        }

        function renderRota() {
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            const staff = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
            const container = document.getElementById('rotaDisplay');

            if (shifts.length === 0) {
                container.innerHTML = '<div class="p-10 text-center text-slate-300 uppercase font-black">No Shifts Added</div>';
                return;
            }

            container.innerHTML = shifts.map(s => `
                <div class="p-6 rounded-[35px] border-2 bg-white flex items-center justify-between mb-4 border-slate-100">
                    <div>
                        <p class="text-[9px] font-black text-orange-500 uppercase">${s.date}</p>
                        <h4 class="font-black text-lg uppercase">${s.role}</h4>
                    </div>
                    <select class="p-4 border-2 rounded-2xl font-black text-xs bg-slate-50 min-w-[180px]">
                        <option value="">-- ASSIGN STAFF --</option>
                        ${staff.filter(st => st.role === s.role).map(st => `<option value="${st.id}">${st.name}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }

        // Start the process
        fetchGoogleData();
    </script>
</body>
</html>
