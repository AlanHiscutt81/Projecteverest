<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Everest - Shift Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8 font-sans text-slate-900">
    <div class="max-w-[1500px] mx-auto">
        
        <nav class="flex gap-4 mb-6">
            <a href="dashboard.html" class="bg-blue-900 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase shadow-lg">Dashboard</a>
            <a href="Staff.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Staff</a>
            <a href="Homes.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Homes</a>
            <a href="calendar.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Calendar</a>
            <a href="payroll.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Payroll</a>
            <a href="invoices.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Invoicing</a>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="bg-white p-8 rounded-[40px] shadow-xl border-t-8 border-orange-500 h-fit">
                <h3 class="font-black uppercase text-[10px] mb-6 text-orange-600 italic tracking-widest text-center">1. Request Vacancy</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Select Home</label>
                        <select id="homeSelect" class="w-full p-4 border-2 rounded-2xl font-black bg-slate-50 outline-none focus:border-orange-500"></select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Date</label>
                        <input id="shiftDate" type="date" class="w-full p-4 border-2 rounded-2xl font-bold bg-slate-50">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="roleReq" class="p-4 border-2 rounded-2xl font-black bg-slate-50"><option>HCA</option><option>RGN</option></select>
                        <select id="shiftType" class="p-4 border-2 rounded-2xl font-black bg-slate-50"><option>Day</option><option>Night</option></select>
                    </div>
                    <button onclick="createShift()" class="w-full bg-orange-600 text-white py-5 rounded-3xl font-black uppercase shadow-xl hover:bg-black transition">Add to Rota</button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-4 rounded-[30px] shadow-sm mb-6 flex items-center justify-between border border-slate-200">
                    <h2 class="text-sm font-black uppercase text-slate-400 ml-4 italic">Active Rota</h2>
                </div>
                <div id="rotaDisplay" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // ORIGINAL KEYS RESTORED
        const STAFF_KEY = 'everest_v5_final';
        const HOME_KEY = 'ev_homes_db'; 
        const SHIFT_KEY = 'ev_shifts_master';

        async function fetchGoogleData() {
            try {
                const response = await fetch("https://docs.google.com/spreadsheets/d/1WvEFHXZrjS3czyjedOLKCcxz6Agt26pTPR33B23kQLo/gviz/tq?tqx=out:json");
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                
                // Pulls James B from your B2 cell
                const rawJsonString = json.table.rows[0].c[1].v;
                const staff = JSON.parse(rawJsonString);

                localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
                renderRota();
            } catch (e) {
                console.log("Google sync pending or failed, using local data.");
                renderRota();
            }
        }

        function init() {
            loadHomeDropdown();
            fetchGoogleData();
            renderRota();
        }

        function loadHomeDropdown() {
            const homes = JSON.parse(localStorage.getItem(HOME_KEY)) || [{name: "Everest Main"}];
            const select = document.getElementById('homeSelect');
            select.innerHTML = homes.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
        }

        function createShift() {
            const date = document.getElementById('shiftDate').value;
            if(!date) return alert("Fill date");
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            shifts.push({
                id: "SHFT-" + Date.now(),
                home: document.getElementById('homeSelect').value,
                date: date,
                role: document.getElementById('roleReq').value,
                status: 'requested'
            });
            localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
            renderRota();
        }

        function renderRota() {
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            const staff = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
            const container = document.getElementById('rotaDisplay');

            if(!shifts.length) {
                container.innerHTML = `<div class="p-20 text-center text-slate-300 font-black uppercase italic border-4 border-dashed rounded-[40px]">No active shifts</div>`;
                return;
            }

            container.innerHTML = shifts.map(s => `
                <div class="p-6 rounded-[35px] border-2 bg-white flex items-center justify-between mb-4 border-slate-100">
                    <div class="flex items-center gap-6">
                        <div class="bg-slate-100 p-4 rounded-3xl text-center min-w-[75px]">
                            <p class="text-2xl font-black">${s.date ? s.date.split('-')[2] : '??'}</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-orange-500 uppercase">${s.home}</p>
                            <h4 class="font-black text-lg uppercase">${s.role} | ${s.date}</h4>
                        </div>
                    </div>
                    <select class="p-4 border-2 rounded-2xl font-black text-xs bg-slate-50 min-w-[180px]">
                        <option value="">-- ASSIGN STAFF --</option>
                        ${staff.filter(st => st.role === s.role).map(st => `<option value="${st.id}">${st.name}</option>`).join('')}
                    </select>
                </div>`).join('');
        }

        window.onload = init;
    </script>
</body>
</html>
