<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Everest - Shift Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8 font-sans text-slate-900">
    <div class="max-w-[1500px] mx-auto">
        
        <nav class="flex gap-4 mb-6">
            <a href="dashboard.html" class="bg-blue-900 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase shadow-lg">Dashboard</a>
            <a href="Staff.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Staff</a>
            <a href="Homes.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Homes</a>
            <a href="calendar.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Calendar</a>
            <a href="payroll.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Payroll</a>
            <a href="invoices.html" class="bg-white text-slate-400 px-6 py-2 rounded-full text-[10px] font-black uppercase border hover:bg-blue-50">Invoicing</a>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="bg-white p-8 rounded-[40px] shadow-xl border-t-8 border-orange-500 h-fit">
                <h3 class="font-black uppercase text-[10px] mb-6 text-orange-600 italic tracking-widest text-center">1. Request Vacancy</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Select Home</label>
                        <select id="homeSelect" class="w-full p-4 border-2 rounded-2xl font-black bg-slate-50 outline-none focus:border-orange-500"></select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Date</label>
                        <input id="shiftDate" type="date" class="w-full p-4 border-2 rounded-2xl font-bold bg-slate-50">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input id="startTime" type="time" class="p-4 border-2 rounded-2xl font-black bg-white text-sm">
                        <input id="endTime" type="time" class="p-4 border-2 rounded-2xl font-black bg-white text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="roleReq" class="p-4 border-2 rounded-2xl font-black bg-slate-50"><option>HCA</option><option>RGN</option></select>
                        <select id="shiftType" class="p-4 border-2 rounded-2xl font-black bg-slate-50"><option>Day</option><option>Night</option></select>
                    </div>
                    <div class="flex items-center gap-3 p-4 bg-red-50 rounded-2xl border-2 border-red-100">
                        <input type="checkbox" id="isBH" class="w-5 h-5 accent-red-600">
                        <label for="isBH" class="text-[10px] font-black uppercase text-red-700">Bank Holiday Rate</label>
                    </div>
                    <button onclick="createShift()" class="w-full bg-orange-600 text-white py-5 rounded-3xl font-black uppercase shadow-xl hover:bg-black transition">Add to Rota</button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-4 rounded-[30px] shadow-sm mb-6 flex items-center justify-between border border-slate-200">
                    <h2 class="text-sm font-black uppercase text-slate-400 ml-4 italic">Active Rota</h2>
                    <div class="flex items-center gap-3">
                        <input type="date" id="filterStart" onchange="renderRota()" class="p-2 border rounded-xl text-xs font-bold outline-none focus:border-blue-900">
                        <input type="date" id="filterEnd" onchange="renderRota()" class="p-2 border rounded-xl text-xs font-bold outline-none focus:border-blue-900">
                    </div>
                </div>
                <div id="rotaDisplay" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const STAFF_KEY = 'everest_v5_final';
        const HOME_KEY = 'ev_homes_db'; 
        const SHIFT_KEY = 'ev_shifts_master';

        function init() {
            const now = new Date();
            const start = new Date(); start.setDate(now.getDate() - 7);
            const end = new Date(); end.setDate(now.getDate() + 14);
            document.getElementById('filterStart').value = start.toISOString().split('T')[0];
            document.getElementById('filterEnd').value = end.toISOString().split('T')[0];
            loadHomeDropdown();
            renderRota();
        }

        function loadHomeDropdown() {
            const homes = JSON.parse(localStorage.getItem(HOME_KEY)) || [];
            const select = document.getElementById('homeSelect');
            const uniqueHomeNames = [...new Set(homes.map(h => h.name))];
            select.innerHTML = uniqueHomeNames.map(name => `<option value="${name}">${name}</option>`).join('') || '<option value="">Empty</option>';
        }

        function createShift() {
            const date = document.getElementById('shiftDate').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            if(!date || !start || !end) return alert("Fill all fields.");
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            shifts.push({
                id: "SHFT-" + Date.now(),
                home: document.getElementById('homeSelect').value,
                date: date, start: start, end: end,
                role: document.getElementById('roleReq').value,
                shiftType: document.getElementById('shiftType').value,
                isBH: document.getElementById('isBH').checked,
                staffId: null, status: 'requested'
            });
            localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
            renderRota();
        }

        function updateShift(id, data) {
            let shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            const idx = shifts.findIndex(s => s.id === id);
            if(idx === -1) return;
            shifts[idx] = {...shifts[idx], ...data};
            localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
            renderRota();
        }

        // Friday Confirmation Logic - Restored Terminology
        function sendBulkConfirmation(staffId) {
            let shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            const staffRegistry = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
            const p = staffRegistry.find(x => x.id === staffId);
            
            if (!p || !p.phone) return alert("No phone number found.");

            const staffShifts = shifts.filter(s => s.staffId === staffId && s.status === 'assigned');
            if(staffShifts.length === 0) return alert("No shifts to confirm.");

            staffShifts.sort((a,b) => new Date(a.date) - new Date(b.date));

            let msg = `Everest Care - Shift Confirmations\n\n`;
            msg += `Staff: ${p.name}\n\n`;
            
            staffShifts.forEach(s => {
                const d = new Date(s.date).toLocaleDateString('en-GB', {weekday: 'long', day: 'numeric', month: 'short'});
                msg += `Location: ${s.home}\nDate: ${d}\nTime: ${s.start} to ${s.end} (${s.shiftType})\n\n`;
                
                const idx = shifts.findIndex(x => x.id === s.id);
                shifts[idx].status = 'confirmed';
            });
            
            msg += `Many Thanks,\nEverest Care Team`;

            let cleanPhone = p.phone.replace(/\s+/g, '');
            if (cleanPhone.startsWith('0')) cleanPhone = '44' + cleanPhone.substring(1);

            const waUrl = `https://web.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(msg)}`;
            window.open(waUrl, '_blank');

            localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
            renderRota();
        }

        function renderRota() {
            const shifts = JSON.parse(localStorage.getItem(SHIFT_KEY)) || [];
            const staff = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
            const container = document.getElementById('rotaDisplay');
            const filterStart = document.getElementById('filterStart').value;
            const filterEnd = document.getElementById('filterEnd').value;

            const filteredShifts = shifts.filter(s => {
                const inRange = (!filterStart || !filterEnd) || (s.date >= filterStart && s.date <= filterEnd);
                return inRange && s.status !== 'completed' && s.status !== 'cancelled';
            });

            if(!filteredShifts.length) {
                container.innerHTML = `<div class="p-20 text-center text-slate-300 font-black uppercase italic border-4 border-dashed rounded-[40px]">No active shifts</div>`;
                return;
            }

            container.innerHTML = filteredShifts.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => {
                const isAssigned = s.status === 'assigned';
                const isConfirmed = s.status === 'confirmed';

                return `
                <div class="p-6 rounded-[35px] border-2 bg-white flex items-center justify-between mb-4 ${isConfirmed ? 'border-blue-500 shadow-lg' : 'border-slate-100'}">
                    <div class="flex items-center gap-6">
                        <div class="bg-slate-100 p-4 rounded-3xl text-center min-w-[75px]">
                            <p class="text-[10px] font-black text-blue-600 uppercase mb-1">${new Date(s.date).toLocaleDateString('en-GB', {weekday: 'short'})}</p>
                            <p class="text-2xl font-black">${new Date(s.date).getDate()}</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-orange-500 uppercase tracking-widest mb-1">${s.home}</p>
                            <h4 class="font-black text-lg uppercase">${s.role} | ${s.start} - ${s.end}</h4>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <select onchange="updateShift('${s.id}', {staffId: this.value, status: this.value ? 'assigned' : 'requested'})" class="p-4 border-2 rounded-2xl font-black text-xs bg-slate-50 min-w-[180px]">
                            <option value="">-- ASSIGN STAFF --</option>
                            ${staff.filter(st => st.role === s.role).map(st => `<option value="${st.id}" ${s.staffId === st.id ? 'selected' : ''}>${st.name}</option>`).join('')}
                        </select>
                        ${isAssigned ? `<button onclick="sendBulkConfirmation('${s.staffId}')" class="bg-blue-600 text-white px-4 py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg">Confirm</button>` : ''}
                        ${isConfirmed ? `<button onclick="updateShift('${s.id}', {status: 'completed'})" class="bg-green-600 text-white px-4 py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg">Complete</button>` : ''}
                        <button onclick="updateShift('${s.id}', {status:'cancelled'})" class="bg-red-50 text-red-500 px-4 py-4 rounded-2xl text-[10px] font-black uppercase">Cancel</button>
                    </div>
                </div>`;
            }).join('');
        }
        window.onload = init;
    </script>
<!-- ===== DEMO: Real-time shared test (Netlify only) ===== -->
<div style="position:fixed;right:12px;bottom:12px;z-index:99999;background:#fff;border:1px solid #ccc;border-radius:10px;padding:12px;max-width:320px;font-family:Arial,sans-serif;box-shadow:0 8px 24px rgba(0,0,0,.15)">
  <div style="font-weight:700;margin-bottom:6px">Live test (shared)</div>
  <div style="margin-bottom:8px;font-size:14px">
    Current value: <span id="rt_value" style="font-weight:700">Loading…</span>
  </div>
  <input id="rt_input" placeholder="Type something…" style="width:100%;padding:8px;border:1px solid #bbb;border-radius:8px;margin-bottom:8px" />
  <button id="rt_send" style="width:100%;padding:8px;border:0;border-radius:8px;cursor:pointer">
    Update everyone’s screen
  </button>
  <div style="margin-top:6px;font-size:12px;opacity:.7">
    Demo-only panel. Remove this block to disable.
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC1ty6QkEVV_peEMYm6dGxw1rTFHferZs",
    authDomain: "everest-project-589d2.firebaseapp.com",
    projectId: "everest-project-589d2",
    storageBucket: "everest-project-589d2.firebasestorage.app",
    messagingSenderId: "913106678619",
    appId: "1:913106678619:web:50984fe3206f1f0c9f207e"
  };

  // IMPORTANT: paste your Firestore document ID from collection "shared" here:
  const DOC_ID = "5VeAsGk1ayJveT6mG4Sr";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ref = doc(db, "shared", DOC_ID);

  onSnapshot(ref, (snap) => {
    const data = snap.data() || {};
    document.getElementById("rt_value").textContent = data.message ?? "(empty)";
  });

  document.getElementById("rt_send").addEventListener("click", async () => {
    const msg = document.getElementById("rt_input").value.trim();
    if (!msg) return;
    await setDoc(ref, { message: msg }, { merge: true });
    document.getElementById("rt_input").value = "";
  });
</script>
<!-- ===== END DEMO BLOCK ===== -->
<script>
fetch("https://docs.google.com/spreadsheets/d/https://docs.google.com/spreadsheets/d/1WvEFHXZrjS3czyjedOLKCcxz6Agt26pTPR33B23kQLo/edit?usp=sharing/gviz/tq?tqx=out:json")
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substr(47).slice(0, -2));
    console.log("Sheet data:", json.table.rows);
  })
  .catch(err => console.error("Sheet error:", err));
</script>
<script>
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vTIK6OOVKAjSflrTOUeiUhoVJz_R8gx826rzuk0j5ECLCTu5E6qyWs8FKOPui3VtP9VSw07i_DkBwJJ/pub?output=csv")
  .then(r => r.text())
  .then(csv => {
    const lines = csv.trim().split("\n");
    const headers = lines[0].split(",");
    const values = lines[1].split(",");

    const row = {};
    headers.forEach((h, i) => row[h.trim()] = values[i]);

    const data = JSON.parse(row.json);
    window.EVEREST_DATA = data;

    console.log("EVEREST DATA LOADED FROM GOOGLE SHEETS", data);
  })
  .catch(err => console.error("GOOGLE SHEETS LOAD FAILED", err));
</script>

</body>

</html>
